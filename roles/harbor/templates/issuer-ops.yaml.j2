apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: letsencrypt-prod-ops
  namespace: harbor
spec:
  acme:
    email: {{ le_email }}
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: le-prod-ops-key
    solvers:
      - http01:
          ingress:
            # ←★ ここは "ingressClassName" だけ残す（"class" は削除）
            ingressClassName: {{ ops_ingress_class }}
            ingressTemplate:
              metadata:
                annotations:
                  nginx.ingress.kubernetes.io/ssl-redirect: "false"
                  nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
          # PSAが厳しい環境でも通るように podTemplate は維持
          podTemplate:
            metadata:
              labels: { app: cm-acme-http-solver }
            spec:
              securityContext:
                runAsNonRoot: true
                seccompProfile: { type: RuntimeDefault }
              containers:
              - name: acmesolver
                securityContext:
                  allowPrivilegeEscalation: false

